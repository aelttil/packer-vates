# Automatisation des Templates Packer

Ce document explique comment utiliser les outils d'automatisation pour la construction et le déploiement des templates Packer.

## Script d'automatisation `process_template.py`

Le script `process_template.py` automatise l'ensemble du processus de construction et de déploiement des templates:

1. Détection automatique du système d'exploitation et de sa version
2. Exécution de Packer
3. Téléchargement du fichier XVA vers S3
4. Génération du fichier JSON de métadonnées
5. Téléchargement des métadonnées et des logs vers S3

### Prérequis

- Python 3.6+
- Packer installé et accessible dans le PATH
- Dépendances Python installées: `pip install -r requirements.txt`
- Fichier `.env` configuré pour l'accès S3

### Utilisation

#### Avec le script shell

```bash
# Syntaxe de base
./build-template.sh <template_file> [var_file]

# Exemple avec Debian 12
./build-template.sh packer/debian/debian12.pkr.hcl
```

Le script shell vérifie automatiquement que tous les fichiers nécessaires existent et propose de créer un fichier `.env` s'il n'existe pas.

#### Avec le script Python directement

```bash
# Syntaxe de base
./process_template.py <template_file> <var_file>

# Exemple avec Debian 12
./process_template.py packer/debian/debian12.pkr.hcl credentials.pkrvars.hcl
```

### Configuration S3

Créez un fichier `.env` à la racine du projet avec les informations d'accès S3:

```
AWS_ACCESS_KEY_ID=votre_cle_acces
AWS_SECRET_ACCESS_KEY=votre_cle_secrete
S3_BUCKET=nom_du_bucket
S3_ENDPOINT_URL=https://s3.fr1.cloud-temple.com
```

### Détection du système d'exploitation

Le script détecte automatiquement le système d'exploitation et sa version en utilisant plusieurs méthodes:

1. Analyse du nom du fichier template (ex: `debian12.pkr.hcl`)
2. Analyse de l'URL ISO dans le fichier HCL
3. Analyse du chemin du fichier template

### Format du fichier de métadonnées

Le script génère un fichier JSON de métadonnées avec le format suivant:

```json
{
  "name": "template-debian-12 Cloud",
  "os": "debian",
  "version": "12.0",
  "target_platform": "openiaas",
  "files": [
    "https://s3.fr1.cloud-temple.com/bucket/templates/debian12/debian12-20250507-123456.xva"
  ],
  "description": "Default password : TOTO Template Debian 12 (12.10), SSH activé, user cloud-init préconfiguré.",
  "logo_url": "https://assets.symbios/logo-debian.png",
  "publisher": "CLOUDTEMPLE",
  "tags": ["Generated by Packer", "debian", "cloud-init"],
  "release_date": "2025-05-07"
}
```

Les tags sont extraits automatiquement du fichier HCL (`vm_tags`).

## Intégration CI/CD

Le projet inclut une configuration GitHub Actions dans `.github/workflows/build-template.yml` qui automatise la construction et le déploiement des templates. Le workflow est configuré pour s'exécuter sur un runner auto-hébergé avec le label `self-hosted`.

### Configuration des secrets GitHub

Pour utiliser la CI/CD, vous devez configurer plusieurs secrets dans votre dépôt GitHub. Consultez le fichier [SECRETS.md](SECRETS.md) pour la liste complète des secrets nécessaires et les instructions de configuration.

### Configuration du runner auto-hébergé

Le workflow est configuré pour s'exécuter sur un runner auto-hébergé, ce qui présente plusieurs avantages:

1. **Accès direct aux ressources**: Le runner peut accéder directement à votre serveur XCP-ng et à votre stockage S3
2. **Performance**: Les builds sont plus rapides car le runner est déjà configuré avec tous les outils nécessaires
3. **Sécurité**: Les informations sensibles restent dans votre environnement

Pour configurer un runner auto-hébergé:

1. Dans votre dépôt GitHub, allez dans **Settings > Actions > Runners**
2. Cliquez sur **New self-hosted runner**
3. Suivez les instructions pour installer et configurer le runner
4. Assurez-vous que le runner a le label `self-hosted`
5. Installez les dépendances nécessaires sur le runner:
   ```bash
   sudo apt-get update
   sudo apt-get install -y python3 python3-pip packer
   ```

### Déclenchement du workflow

Le workflow peut être déclenché de trois façons:

1. **Automatiquement** lors d'un push sur la branche `main` qui modifie des fichiers dans le dossier `packer/`
2. **Automatiquement** lors d'une pull request vers la branche `main`
3. **Manuellement** via l'interface GitHub Actions, avec la possibilité de spécifier le template à construire

### Artefacts

Le workflow télécharge les artefacts suivants vers GitHub:

- Fichier JSON de métadonnées
- Fichier log de la construction

Le fichier XVA est téléchargé uniquement vers S3 en raison de sa taille.

## Ajout d'un nouveau template

Pour ajouter un nouveau template (par exemple Ubuntu 22.04):

1. Créez le fichier template HCL dans `packer/ubuntu/ubuntu22.pkr.hcl`
2. Assurez-vous que le template inclut des `vm_tags` appropriés
3. Exécutez le script manuellement ou via la CI/CD

Le script détectera automatiquement qu'il s'agit d'Ubuntu 22.04 et générera les métadonnées appropriées.

## Dépannage

### Problèmes de détection du système d'exploitation

Si le script ne détecte pas correctement le système d'exploitation ou sa version, vous pouvez ajouter des indices supplémentaires:

1. Nommez votre fichier template de manière explicite (ex: `debian12.pkr.hcl`)
2. Utilisez un chemin explicite (ex: `packer/debian/debian12.pkr.hcl`)
3. Assurez-vous que l'URL ISO contient des informations sur la distribution et la version

### Problèmes d'accès S3

Vérifiez les points suivants:

1. Le fichier `.env` est correctement configuré
2. Les clés d'accès S3 ont les permissions nécessaires
3. L'endpoint S3 est accessible depuis votre machine ou le runner CI/CD
